<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>LIFF Dynamic Flex Sharer</title>
    <!-- ใช้ Alert Custom แทน alert() -->
    <style>
        .custom-alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .custom-alert-box {
            background: #fff; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .custom-alert-box button {
            margin-top: 15px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>กำลังโหลดข้อมูล...</h1>
    <p>กรุณารอสักครู่ (หากค้างนาน แสดงว่าเกิดปัญหาการเชื่อมต่อ)</p>
    <p id="debug-info" style="color: red; font-weight: bold;"></p>
    
    <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>

    <script>
        // ⭐ 1. CONFIG: LIFF ID ของคุณ (ต้องตรงกับที่ใช้ในปุ่มแชร์)
        const LIFF_ID = "1657584857-WRzPzB9g"; 
        
        // ⭐ 2. URL ของ GAS Web App (ต้องเป็น URL ที่ Deploy แล้ว)
        // (นำ URL จาก GAS Web App Deployment ของคุณมาใส่ที่นี่)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwBCifWgs3FMWX6U5ZxFTq5Vb190B9W6Vj9bAol07vTE9I8LZ3yR0lj1S7nntAHLQyJ8Q/exec'; 

        // ฟังก์ชัน Custom Alert แทน alert()
        function customAlert(message) {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            const box = document.createElement('div');
            box.className = 'custom-alert-box';
            box.innerHTML = `<p>${message}</p><button onclick="this.closest('.custom-alert-overlay').remove()">ตกลง</button>`;
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }
        
        // ฟังก์ชันสำหรับแยก Query Parameter จาก URL (รองรับ liff.state)
        function getQueryParams() {
            var params = {};
            var query = window.location.search.substring(1); 
            
            var liffStateMatch = query.match(/liff\.state=([^&]*)/);
            if (liffStateMatch) {
                var liffStateQuery = decodeURIComponent(liffStateMatch[1]);
                if (liffStateQuery.startsWith('?')) {
                    query += '&' + liffStateQuery.substring(1);
                }
            }

            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] && pair[1]) { 
                    // ⭐ templateId คือ Key ที่เราจะใช้
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
            return params;
        }

        async function main() {
            let templateId = '';
            try {
                // 1. เริ่มต้น (Initialize) LIFF
                await liff.init({ liffId: LIFF_ID });

                // 2. ดึง Template ID จาก URL (นี่คือ 'กุญแจ' ที่ GAS ส่งมา)
                var params = getQueryParams();
                templateId = params.templateId || ''; // ใช้ Key: templateId

                if (!templateId) {
                    throw new Error('ไม่พบ Template ID ใน URL (Template ID หายไป)');
                }
                
                document.getElementById('debug-info').innerText = `Template ID ที่รับได้: ${templateId} กำลังดึง Flex JSON จาก Server...`;

                // 3. เรียก GAS Server เพื่อดึง Flex JSON
                // Action: getTemplateFlex คือ Handler ที่เราเพิ่มใน GAS
                const fetchUrl = `${GAS_WEB_APP_URL}?action=getTemplateFlex&templateId=${templateId}`;
                const response = await fetch(fetchUrl);

                // ตรวจสอบ HTTP Error
                if (!response.ok) {
                    const errorText = await response.text(); 
                    throw new Error(`GAS API Error: HTTP ${response.status}. Check CORS/Deployment.`);
                }

                // 4. รับ Flex JSON ทั้งก้อนกลับมา
                const responseData = await response.json(); 

                if (responseData.error) {
                    throw new Error(responseData.error); // Error จาก GAS Server
                }
                if (!responseData.contents) {
                    throw new Error('ไม่พบโค้ด Flex Message (contents) ใน Template ID นี้');
                }
                
                // 5. สร้าง Flex Message สำหรับ Share Target Picker
                const finalFlexMessage = {
                    "type": "flex",
                    "altText": responseData.altText || "Flex Message for Sharing",
                    "contents": responseData.contents // โค้ด Flex JSON ทั้งก้อนที่ดึงมาจาก Sheet
                };

                // 6. เรียกใช้ Share Target Picker
                document.getElementById('debug-info').innerText = `ดึงข้อมูลสำเร็จ! กำลังเปิดหน้าแชร์...`;
                
                // ⭐⭐ ใช้ Flex JSON ที่ดึงมา
                await liff.shareTargetPicker([finalFlexMessage]);

                // 7. ปิดหน้าต่าง LIFF
                customAlert("แชร์ข้อความสำเร็จแล้ว!");
                liff.closeWindow();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการทำงานของ LIFF:", error);
                const msg = `❌ เกิดข้อผิดพลาด: ${error.message}`;
                document.getElementById('debug-info').innerText = msg;
                customAlert(msg);
                liff.closeWindow();
            }
        }

        // เริ่มต้น
        main();
    </script>
</body>
</html>
