<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>Chokdee Content Flex Sharer</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #000;
        }

        /* ฉากโหลดเต็มจอ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #001f3f 0, #000000 60%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        /* วงกลมหมุน */
        .loader {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.2);
            border-top-color: #00c300; /* สีเขียวโทน LINE */
            animation: spin 1s linear infinite;
        }

        /* จุดกระพริบด้านล่าง เพิ่มความรู้สึกกำลังทำงาน */
        .loading-dots {
            margin-top: 16px;
            width: 40px;
            display: flex;
            justify-content: space-between;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.7);
            opacity: 0.2;
            animation: blink 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0.2; transform: scale(1); }
            40% { opacity: 1; transform: scale(1.3); }
        }

        /* กล่อง alert แบบ custom */
        .custom-alert-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .custom-alert-box {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .custom-alert-box button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* debug-info ซ่อนไว้ ใช้ดู log ถ้าต้องการ */
        #debug-info {
            display: none;
        }
    </style>
</head>
<body>
    <!-- overlay โหลดหมุน ๆ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- debug ซ่อนไว้ ไม่ให้ลูกค้าเห็น -->
    <p id="debug-info"></p>
    
    <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>

    <script>
        const LIFF_ID = "1657584857-WRzPzB9g"; 
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxYHWtdUbGgnRXXVhAxQnM6meYfvBFbonVQpFUOAuRjKkhCLrCCehMqxMmEVmPOV0u34g/exec";

        function customAlert(message) {
            const overlay = document.createElement("div");
            overlay.className = "custom-alert-overlay";
            const box = document.createElement("div");
            box.className = "custom-alert-box";
            box.innerHTML =
                `<p style="white-space:pre-line">${message}</p>` +
                `<button onclick="this.closest('.custom-alert-overlay').remove()">ตกลง</button>`;
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        function getQueryParams() {
            var params = {};
            var query = window.location.search.substring(1);

            var liffStateMatch = query.match(/liff\.state=([^&]*)/);
            if (liffStateMatch) {
                var liffStateQuery = decodeURIComponent(liffStateMatch[1]);
                if (liffStateQuery.startsWith("?")) {
                    query += "&" + liffStateQuery.substring(1);
                }
            }

            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] && pair[1]) {
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
            return params;
        }

        async function main() {
            let templateId = "";
            const loading = document.getElementById("loading-overlay");
            const debug = document.getElementById("debug-info");

            try {
                debug.innerText = "init LIFF...";

                await liff.init({ liffId: LIFF_ID });

                if (!liff.isInClient()) {
                    loading.style.display = "none";
                    const msg =
                        "ฟังก์ชันแชร์ใช้ได้เฉพาะเมื่อเปิดในแอป LINE เท่านั้น\n" +
                        "กรุณากลับไปเปิดลิงก์นี้จากในห้องแชท LINE ครับ";
                    debug.innerText = msg;
                    customAlert(msg);
                    return;
                }

                if (!liff.isApiAvailable("shareTargetPicker")) {
                    loading.style.display = "none";
                    const msg =
                        "อุปกรณ์หรือเวอร์ชัน LINE นี้ไม่รองรับ Share Target Picker\n" +
                        "กรุณาอัปเดตแอป LINE ให้เป็นเวอร์ชันล่าสุด แล้วลองใหม่อีกครั้งครับ";
                    debug.innerText = msg;
                    customAlert(msg);
                    return;
                }

                const params = getQueryParams();
                templateId = params.templateId || "";

                if (!templateId) {
                    throw new Error("ไม่พบ Template ID ใน URL (templateId=...)");
                }

                debug.innerText = "fetch flex from GAS...";

                const fetchUrl =
                    `${GAS_WEB_APP_URL}?action=getTemplateFlex&templateId=` +
                    encodeURIComponent(templateId);
                const response = await fetch(fetchUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(
                        `GAS API Error: HTTP ${response.status}\nDetails: ${errorText.substring(
                            0,
                            200
                        )}`
                    );
                }

                const responseData = await response.json();

                if (responseData.error) {
                    throw new Error(responseData.error);
                }
                if (!responseData.contents) {
                    throw new Error(
                        "ไม่พบโค้ด Flex Message (contents) ใน Template ID นี้"
                    );
                }

                const finalFlexMessage = {
                    type: "flex",
                    altText: responseData.altText || "Flex Message for Sharing",
                    contents: responseData.contents,
                };

                debug.innerText = "open shareTargetPicker...";

                const result = await liff.shareTargetPicker([finalFlexMessage]);

                if (result === null) {
                    // user ปิดโดยไม่แชร์
                    loading.style.display = "none";
                    customAlert("ปิดหน้าต่างแชร์โดยไม่ได้ส่งข้อความครับ");
                    liff.closeWindow();
                    return;
                }

                // แชร์สำเร็จ
                loading.style.display = "none";
                customAlert("แชร์ข้อความสำเร็จแล้ว!");
                setTimeout(() => {
                    liff.closeWindow();
                }, 500);
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการทำงานของ LIFF:", error);
                loading.style.display = "none";
                const msg = `❌ เกิดข้อผิดพลาด:\n${error.message || error}`;
                debug.innerText = msg;
                customAlert(msg);
            }
        }

        main();
    </script>
</body>
</html>
